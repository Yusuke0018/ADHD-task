<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>統計 - 二十四節気タスク</title>
    <link rel="stylesheet" href="styles/base.css?v=3">
    <link rel="stylesheet" href="styles/sekki-backgrounds.css?v=3">
    <link rel="stylesheet" href="styles/animations.css?v=3">
    <link rel="stylesheet" href="styles/components.css?v=3">
    <style>
        .statistics-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 80px;
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1001;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateX(-5px);
        }
        
        .stats-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats-section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-weight: bold;
            color: #666;
        }
        
        .stat-value {
            color: #333;
            font-weight: bold;
        }
        
        .date-range-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .period-button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .period-button:hover {
            background: #f5f5f5;
        }
        
        .period-button.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .chart-label {
            width: 100px;
            font-size: 12px;
            color: #666;
        }
        
        .chart-bar-bg {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 10px;
        }
        
        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .chart-value {
            width: 50px;
            text-align: right;
            font-weight: bold;
            color: #333;
        }
        
        .reflection-item {
            background: #f0f9ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3b82f6;
        }
        
        .reflection-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .reflection-text {
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }
        
        .ai-comment-item {
            background: #faf5ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #8b5cf6;
        }
        
        .ai-comment-period {
            font-size: 12px;
            color: #666;
            background: #e9d5ff;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 4px;
        }
        
        .ai-comment-text {
            font-size: 14px;
            color: #333;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        .achievement-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .achievement-excellent {
            background: #10b981;
            color: white;
        }
        
        .achievement-good {
            background: #3b82f6;
            color: white;
        }
        
        .achievement-normal {
            background: #f59e0b;
            color: white;
        }
        
        .achievement-low {
            background: #ef4444;
            color: white;
        }
        
        .task-completion-chart {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .completion-bar {
            flex: 1;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .completion-fill {
            height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .trend-up {
            color: #10b981;
            background: #d1fae5;
        }
        
        .trend-down {
            color: #ef4444;
            background: #fee2e2;
        }
        
        .trend-neutral {
            color: #6b7280;
            background: #f3f4f6;
        }
        
        @media (max-width: 640px) {
            .statistics-container {
                padding: 10px;
                padding-top: 70px;
            }
            
            .back-button {
                top: 10px;
                left: 10px;
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .period-button {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <button class="back-button" onclick="window.location.href='index.html'">← 戻る</button>
    
    <div id="animationContainer"></div>
    
    <div class="statistics-container">
        <h1 style="text-align: center; margin-bottom: 30px;">統計情報</h1>
        
        <div class="date-range-selector">
            <button class="period-button active" onclick="showStats('daily')">今日</button>
            <button class="period-button" onclick="showStats('weekly')">今週</button>
            <button class="period-button" onclick="showStats('sekki')">今節気</button>
            <button class="period-button" onclick="showStats('monthly')">今月</button>
            <button class="period-button" onclick="showStats('quarterly')">四半期</button>
            <button class="period-button" onclick="showStats('yearly')">年間</button>
            <button class="period-button" onclick="showStats('all')">全期間</button>
        </div>
        
        <div id="statsContent">
            <!-- 統計情報がここに動的に表示されます -->
        </div>
    </div>
    
    <script src="js/data/sekki-data.js?v=3"></script>
    <script src="js/animations/seasonal-animations.js?v=3"></script>
    <script>
        let currentPeriod = 'daily';
        
        function loadData() {
            const saved = localStorage.getItem('focusTaskData');
            if (!saved) return null;
            return JSON.parse(saved);
        }
        
        function loadProjectsData() {
            const savedProjects = localStorage.getItem('hakoniwa_projects');
            const savedHallOfFame = localStorage.getItem('hakoniwa_hall_of_fame');
            return {
                projects: savedProjects ? JSON.parse(savedProjects) : [],
                hallOfFame: savedHallOfFame ? JSON.parse(savedHallOfFame) : []
            };
        }
        
        function calculateStats(period) {
            const data = loadData();
            if (!data) {
                console.log('No data found in localStorage');
                return null;
            }
            
            console.log('Loaded data:', data);
            console.log('Tasks:', data.tasks);
            console.log('Tasks length:', data.tasks ? data.tasks.length : 0);
            
            const now = new Date();
            const today = now.toDateString();
            let startDate, endDate;
            
            switch(period) {
                case 'daily':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case 'weekly':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    endDate = new Date(now);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'sekki':
                    const currentSekki = getCurrentSekki();
                    startDate = new Date(currentSekki.start);
                    endDate = new Date(currentSekki.end);
                    break;
                case 'monthly':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'quarterly':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'yearly':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
                case 'all':
                    startDate = new Date('2000-01-01');
                    endDate = new Date('2100-12-31');
                    break;
            }
            
            // タスク統計
            let totalTasks = 0;
            let completedTasks = 0;
            let totalPoints = 0;
            let daysWithData = 0;
            let reflectionDays = 0;
            let aiCommentDays = 0;
            let tasksByType = { normal: 0, urgent: 0 };
            let completedByType = { normal: 0, urgent: 0 };
            let dailyCompletionRates = [];
            let reflections = [];
            let aiComments = [];
            let streakDays = 0;
            let currentStreak = 0;
            let maxStreak = 0;
            let previousDayCompleted = false;
            
            // プロジェクトデータを読み込み
            const projectsData = loadProjectsData();
            let totalProjectPoints = 0;
            let activeProjects = projectsData.projects.length;
            let completedProjects = projectsData.hallOfFame.length;
            let projectsByLevel = {};
            
            // アクティブプロジェクトの統計
            projectsData.projects.forEach(project => {
                totalProjectPoints += project.pt || 0;
                const level = project.level || 1;
                projectsByLevel[level] = (projectsByLevel[level] || 0) + 1;
            });
            
            // 殿堂入りプロジェクトのポイントも含める
            projectsData.hallOfFame.forEach(project => {
                // 殿堂入りプロジェクトは基本的にレベル10で完成
                const basePoints = project.basePoints || 100;
                const totalEarnedPoints = basePoints * 45; // 1+2+3+...+9 = 45
                totalProjectPoints += totalEarnedPoints;
            });
            
            // 日付範囲内のデータを集計
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toDateString();
                
                // その日のタスクを確認
                const dayTasks = (data.tasks || []).filter(t => {
                    if (!t || !t.scheduledFor) return false;
                    const taskDate = new Date(t.scheduledFor);
                    return taskDate.toDateString() === dateStr;
                });
                
                let dayCompleted = 0;
                let dayTotal = 0;
                
                if (dayTasks.length > 0) {
                    daysWithData++;
                    dayTasks.forEach(task => {
                        totalTasks++;
                        dayTotal++;
                        if (task.type === 'normal') tasksByType.normal++;
                        else tasksByType.urgent++;
                        
                        if (task.isCompleted) {
                            completedTasks++;
                            dayCompleted++;
                            if (task.type === 'normal') completedByType.normal++;
                            else completedByType.urgent++;
                        }
                    });
                    
                    // 日別達成率を記録
                    const dayRate = Math.round((dayCompleted / dayTotal) * 100);
                    dailyCompletionRates.push({
                        date: new Date(d),
                        rate: dayRate,
                        completed: dayCompleted,
                        total: dayTotal
                    });
                    
                    // ストリーク計算
                    if (dayRate >= 80) {
                        if (previousDayCompleted) {
                            currentStreak++;
                        } else {
                            currentStreak = 1;
                        }
                        previousDayCompleted = true;
                        maxStreak = Math.max(maxStreak, currentStreak);
                    } else {
                        previousDayCompleted = false;
                        currentStreak = 0;
                    }
                }
                
                // ポイント
                if (data.dailyPointHistory && data.dailyPointHistory[dateStr]) {
                    totalPoints += data.dailyPointHistory[dateStr];
                }
                
                // 振り返り
                if (data.dailyReflections && data.dailyReflections[dateStr]) {
                    reflectionDays++;
                    reflections.push({
                        date: new Date(d),
                        text: data.dailyReflections[dateStr]
                    });
                }
                
                // AIコメント
                if (data.dailyAIComments && data.dailyAIComments[dateStr]) {
                    const comments = data.dailyAIComments[dateStr];
                    const hasComments = Object.keys(comments).length > 0;
                    if (hasComments) {
                        aiCommentDays++;
                        for (const [period, comment] of Object.entries(comments)) {
                            aiComments.push({
                                date: new Date(d),
                                period: period,
                                text: comment.content || comment
                            });
                        }
                    }
                }
            }
            
            // 日次ポイント履歴（最大7日分）
            const pointHistory = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toDateString();
                const points = data.dailyPointHistory && data.dailyPointHistory[dateStr] || 0;
                pointHistory.push({
                    date: d,
                    points: points
                });
            }
            
            // 平均達成率
            const avgCompletionRate = dailyCompletionRates.length > 0
                ? Math.round(dailyCompletionRates.reduce((sum, d) => sum + d.rate, 0) / dailyCompletionRates.length)
                : 0;
            
            // 前期間との比較（トレンド分析）
            let trend = 'neutral';
            if (period !== 'all' && daysWithData > 0) {
                const prevStats = calculatePreviousPeriodStats(period, startDate);
                if (prevStats && prevStats.completionRate > 0) {
                    const rateDiff = totalTasks > 0 ? 
                        Math.round((completedTasks / totalTasks) * 100) - prevStats.completionRate : 0;
                    if (rateDiff > 5) trend = 'up';
                    else if (rateDiff < -5) trend = 'down';
                }
            }
            
            return {
                period: period,
                startDate: startDate,
                endDate: endDate,
                totalTasks: totalTasks,
                completedTasks: completedTasks,
                completionRate: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0,
                totalPoints: totalPoints,
                daysWithData: daysWithData,
                reflectionDays: reflectionDays,
                aiCommentDays: aiCommentDays,
                averagePointsPerDay: daysWithData > 0 ? Math.round(totalPoints / daysWithData) : 0,
                tasksByType: tasksByType,
                completedByType: completedByType,
                pointHistory: pointHistory,
                dailyCompletionRates: dailyCompletionRates,
                avgCompletionRate: avgCompletionRate,
                maxStreak: maxStreak,
                reflections: reflections.slice(-5), // 最新5件
                aiComments: aiComments.slice(-5), // 最新5件
                trend: trend,
                totalProjectPoints: totalProjectPoints,
                activeProjects: activeProjects,
                completedProjects: completedProjects,
                projectsByLevel: projectsByLevel
            };
        }
        
        function calculatePreviousPeriodStats(period, currentStartDate) {
            const data = loadData();
            if (!data) return null;
            
            let startDate, endDate;
            const prevDate = new Date(currentStartDate);
            
            switch(period) {
                case 'daily':
                    prevDate.setDate(prevDate.getDate() - 1);
                    startDate = new Date(prevDate);
                    endDate = new Date(prevDate);
                    break;
                case 'weekly':
                    prevDate.setDate(prevDate.getDate() - 7);
                    startDate = new Date(prevDate);
                    endDate = new Date(prevDate);
                    endDate.setDate(endDate.getDate() + 6);
                    break;
                case 'monthly':
                    prevDate.setMonth(prevDate.getMonth() - 1);
                    startDate = new Date(prevDate.getFullYear(), prevDate.getMonth(), 1);
                    endDate = new Date(prevDate.getFullYear(), prevDate.getMonth() + 1, 0);
                    break;
                default:
                    return null;
            }
            
            let totalTasks = 0;
            let completedTasks = 0;
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toDateString();
                const dayTasks = data.tasks.filter(t => {
                    const taskDate = new Date(t.scheduledFor);
                    return taskDate.toDateString() === dateStr;
                });
                
                dayTasks.forEach(task => {
                    totalTasks++;
                    if (task.isCompleted) completedTasks++;
                });
            }
            
            return {
                completionRate: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0
            };
        }
        
        function getCurrentSekki() {
            const now = new Date();
            const year = now.getFullYear();
            
            // sekki-data.jsからのデータ
            const sekkiData = window.sekkiDates && window.sekkiDates[year] ? window.sekkiDates[year] : [];
            
            for (let i = 0; i < sekkiData.length; i++) {
                const current = new Date(sekkiData[i].date);
                const next = i < sekkiData.length - 1 ? 
                    new Date(sekkiData[i + 1].date) : 
                    new Date(year + 1, 0, 1);
                
                if (now >= current && now < next) {
                    return {
                        name: sekkiData[i].name,
                        start: current,
                        end: new Date(next.getTime() - 1)
                    };
                }
            }
            return null;
        }
        
        function formatDateRange(startDate, endDate) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            if (startDate.toDateString() === endDate.toDateString()) {
                return startDate.toLocaleDateString('ja-JP', options);
            }
            return `${startDate.toLocaleDateString('ja-JP', options)} 〜 ${endDate.toLocaleDateString('ja-JP', options)}`;
        }
        
        function createChart(pointHistory) {
            const maxPoints = Math.max(...pointHistory.map(h => h.points), 10);
            return pointHistory.map(h => {
                const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
                const label = `${h.date.getMonth() + 1}/${h.date.getDate()}(${weekdays[h.date.getDay()]})`;
                const percentage = (h.points / maxPoints * 100).toFixed(0);
                
                return `
                    <div class="chart-bar">
                        <div class="chart-label">${label}</div>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="chart-value">${h.points}pt</div>
                    </div>
                `;
            }).join('');
        }
        
        function showStats(period) {
            currentPeriod = period;
            
            // ボタンのアクティブ状態を更新
            document.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const stats = calculateStats(period);
            const content = document.getElementById('statsContent');
            
            if (!stats) {
                content.innerHTML = '<div class="stats-section"><p>データがありません</p></div>';
                return;
            }
            
            const sekkiInfo = period === 'sekki' ? getCurrentSekki() : null;
            
            // 達成度バッジを決定
            let achievementClass = 'achievement-low';
            let achievementText = '要改善';
            if (stats.completionRate >= 90) {
                achievementClass = 'achievement-excellent';
                achievementText = '素晴らしい！';
            } else if (stats.completionRate >= 70) {
                achievementClass = 'achievement-good';
                achievementText = '良好';
            } else if (stats.completionRate >= 50) {
                achievementClass = 'achievement-normal';
                achievementText = '普通';
            }
            
            // トレンドアイコン
            const trendIcon = stats.trend === 'up' ? '↑' : stats.trend === 'down' ? '↓' : '→';
            const trendClass = `trend-${stats.trend}`;
            
            content.innerHTML = `
                <div class="stats-section">
                    <h2>期間サマリー</h2>
                    ${sekkiInfo ? `<div class="stat-item"><span class="stat-label">節気</span><span class="stat-value">${sekkiInfo.name}</span></div>` : ''}
                    <div class="stat-item">
                        <span class="stat-label">期間</span>
                        <span class="stat-value">${formatDateRange(stats.startDate, stats.endDate)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">達成度</span>
                        <span class="stat-value">
                            <span class="achievement-badge ${achievementClass}">${achievementText}</span>
                            ${stats.trend !== 'neutral' ? `<span class="trend-indicator ${trendClass}">${trendIcon}</span>` : ''}
                        </span>
                    </div>
                </div>
                
                <div class="stats-section">
                    <h2>タスク達成率</h2>
                    <div class="task-completion-chart">
                        <div class="completion-bar">
                            <div class="completion-fill" style="width: ${stats.completionRate}%">
                                ${stats.completionRate}%
                            </div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">総タスク数</span>
                        <span class="stat-value">${stats.totalTasks}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">完了タスク</span>
                        <span class="stat-value">${stats.completedTasks}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">平均達成率</span>
                        <span class="stat-value">${stats.avgCompletionRate}%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">通常タスク</span>
                        <span class="stat-value">${stats.completedByType.normal}/${stats.tasksByType.normal}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">目標タスク</span>
                        <span class="stat-value">${stats.completedByType.urgent}/${stats.tasksByType.urgent}</span>
                    </div>
                    ${stats.maxStreak > 0 ? `
                    <div class="stat-item">
                        <span class="stat-label">最長連続達成</span>
                        <span class="stat-value">${stats.maxStreak}日間</span>
                    </div>
                    ` : ''}
                </div>
                
                <div class="stats-section">
                    <h2>ポイント統計</h2>
                    <div class="stat-item">
                        <span class="stat-label">獲得ポイント</span>
                        <span class="stat-value">${stats.totalPoints}pt</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">平均ポイント/日</span>
                        <span class="stat-value">${stats.averagePointsPerDay}pt</span>
                    </div>
                </div>
                
                <div class="stats-section">
                    <h2>プロジェクト統計</h2>
                    <div class="stat-item">
                        <span class="stat-label">アクティブプロジェクト</span>
                        <span class="stat-value">${stats.activeProjects}件</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">完成プロジェクト</span>
                        <span class="stat-value">${stats.completedProjects}件</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">プロジェクト総ポイント</span>
                        <span class="stat-value">${stats.totalProjectPoints}pt</span>
                    </div>
                    ${Object.keys(stats.projectsByLevel).length > 0 ? `
                    <div class="stat-item">
                        <span class="stat-label">レベル分布</span>
                        <span class="stat-value">
                            ${Object.entries(stats.projectsByLevel)
                                .sort(([a], [b]) => parseInt(a) - parseInt(b))
                                .map(([level, count]) => `Lv${level}: ${count}件`)
                                .join(', ')}
                        </span>
                    </div>
                    ` : ''}
                </div>
                
                <div class="stats-section">
                    <h2>活動統計</h2>
                    <div class="stat-item">
                        <span class="stat-label">活動日数</span>
                        <span class="stat-value">${stats.daysWithData}日</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">振り返り記入率</span>
                        <span class="stat-value">${stats.daysWithData > 0 ? Math.round((stats.reflectionDays / stats.daysWithData) * 100) : 0}%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">AIコメント利用率</span>
                        <span class="stat-value">${stats.daysWithData > 0 ? Math.round((stats.aiCommentDays / stats.daysWithData) * 100) : 0}%</span>
                    </div>
                </div>
                
                ${stats.reflections.length > 0 ? `
                <div class="stats-section">
                    <h2>最近の振り返り</h2>
                    ${stats.reflections.map(r => `
                        <div class="reflection-item">
                            <div class="reflection-date">${r.date.toLocaleDateString('ja-JP')}</div>
                            <div class="reflection-text">${r.text}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                ${stats.aiComments.length > 0 ? `
                <div class="stats-section">
                    <h2>最近のAIコメント</h2>
                    ${stats.aiComments.map(c => `
                        <div class="ai-comment-item">
                            <div class="reflection-date">${c.date.toLocaleDateString('ja-JP')}</div>
                            <span class="ai-comment-period">${
                                c.period === 'daily' ? 'デイリー' :
                                c.period === 'weekly' ? '週間' :
                                c.period === 'sekki' ? '節気' :
                                c.period === 'monthly' ? '月間' : '四半期'
                            }</span>
                            <div class="ai-comment-text">${c.text.substring(0, 200)}${c.text.length > 200 ? '...' : ''}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                ${period === 'daily' || period === 'weekly' ? `
                <div class="stats-section">
                    <h2>ポイント推移（過去7日間）</h2>
                    <div class="chart-container">
                        ${createChart(stats.pointHistory)}
                    </div>
                </div>
                ` : ''}
            `;
        }
        
        // 初期表示
        document.addEventListener('DOMContentLoaded', () => {
            // アニメーションを設定
            const now = new Date();
            const sekki = getCurrentSekki();
            if (sekki) {
                document.body.className = `sekki-${sekki.name}`;
                createSeasonalAnimation(sekki.name);
            }
            
            // 統計を表示
            showStats('daily');
        });
    </script>
</body>
</html>