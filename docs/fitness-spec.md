# フィットネス拡張仕様 v1.0（ラン/ウォーク/サイクル）

最終更新: 2025-09-09

## 目的と概要
- 手入力で「ランニング／ウォーキング／サイクリング」の距離[km]と分[min]を記録し、XP（経験値）とレベル、称号（アチーブメント）を解放します。
- 「総合（加重総距離）」称号は、下記の重みで距離を合算します。
  - 加重総距離[km] = 2.5 × 累計ラン[km] + 1.25 × 累計ウォーク[km] + 1.0 × 累計サイクル[km]
- レベル用のXPは別系統で算出し、同条件ならランニングの評価が他の2倍以上になるよう係数を設定します（詳細は「XPとレベル」）。

## スコープ（v1）
- 入力（種目/距離/分/日付/メモ）→保存→XP・レベル更新→称号解放→演出表示（通常）まで。
- 対応カテゴリ: 総合、ラン距離、ウォーク距離、サイクル距離、総時間、累計日数。
- v1.1で追加: 特殊コンボ称号、節目レベルの大演出、装備バッジ、週間目標/ストリーク。

## 用語・単位
- 距離: km（小数2桁まで入力・表示推奨）。
- 時間: 分（整数）。
- 速度: km/h（距離÷(分/60)で算出、異常値チェックにのみ使用）。
- 週の開始: 月曜 00:00（タイムゾーン: Asia/Tokyo）。

## ユースケース（要約）
1) ユーザーが当日/過去日の運動を手入力し保存する。
2) システムがXPを計算し、累計に加算→レベル判定。
3) 各カテゴリの称号テーブルを差分評価し、新規解放があればキューに積む。
4) 通常演出を再生。節目レベルや希少称号は大演出（v1.1）。
5) ダッシュボードに今日/今週/累計の距離・分・回数、称号サマリ、次に狙える称号を提示。

## データモデル（LocalStorage想定）

### Activity（運動ログ）
```
Activity = {
  id: string,                    // uuid
  date: string,                  // ISO日付 "YYYY-MM-DD"（保存時に正規化）
  type: 'run' | 'walk' | 'cycle',
  distanceKm: number,            // 0.00〜200.00
  minutes: number,               // 1〜600
  time?: string,                 // 任意 'HH:MM'（コンボ判定用: 朝6時まで 等）
  note?: string
}
```

### Totals（集計キャッシュ）
```
Totals = {
  byType: {
    run:   { distanceKm: number, minutes: number, count: number },
    walk:  { distanceKm: number, minutes: number, count: number },
    cycle: { distanceKm: number, minutes: number, count: number }
  },
  weightedTotalKm: number,       // 加重総距離（小数2桁で保持）
  totalMinutes: number,          // 全種目合算（分）
  uniqueDays: number,            // 記録が1つ以上あるユニーク日数
  weekly: { [weekKey: string]: { runKm:number, walkKm:number, cycleKm:number, minutes:number, count:number } },
  monthly: { [monthKey: string]: { ... 同上 ... } }
}
```

### Profile（レベル・設定）
```
Profile = {
  level: number,
  totalXp: number,
  nextLevelRequiredXp: number,
  settings: {
    distanceWeight: number,      // 既定 12（距離寄り微調整用）
    timeWeight: number,          // 既定 5（時間寄り微調整用）
    speedAlerts: boolean         // 異常速度警告 ON/OFF（既定ON）
  }
}
```

### Achievement（称号）
```
Achievement = {
  id: string,                    // 例: sum_0001, run_0012 ...（下記ID設計）
  category: 'sum'|'run'|'walk'|'cycle'|'time'|'days'|'combo',
  name: string,                  // 日本語名（固定）
  threshold: number,             // 距離[km]/分/日/ルールID
  unit: 'km'|'min'|'day'|'rule',
  scope: 'cumulative'|'single'|'weekly'|'daily',
  unlockedAt?: string            // ISO-8601（未解放なら未設定）
}
```

### Storage Keys（案）
- `fitness_activities`（Activity[]）
- `fitness_totals`（Totals）
- `fitness_profile`（Profile）
- `fitness_achievements`（Achievement[]、全リストを初期投入してlocked状態で保持）

## バリデーションと丸め
- 距離: 0 < d ≤ 200.00（小数2桁に丸め）。
- 分: 1 ≤ m ≤ 600。
- 速度異常の警告（保存前確認ダイアログ）:
  - run > 25 km/h、walk > 9 km/h、cycle > 60 km/h（編集で上書き可能）。
- 日付: 入力が任意。未入力は今日扱い。保存時に `YYYY-MM-DD` に正規化。

## XP とレベル
- 目的: 同距離・同時間の入力で「ランニングのXPがウォーク/サイクルの2倍以上」。
- 基底スコア: `base = 12 × (距離^0.9) + 5 × √(分)`
- 種目係数: `run=2.4`, `walk=1.2`, `cycle=1.0`
- XP: `XP = round(base × 種目係数)`
- レベル曲線: 次レベル必要XP `req(L) = round(120 + 30 × L^1.2)`
- 節目レベル（大演出の対象、v1.1）: `5, 10, 20, 30, 50`
- 連続/週間達成ボーナス: 最大+10%（v1.2）。

## 称号の判定ロジック（共通）
1) 保存後、差分でTotalsを更新（byType、weightedTotal、totalMinutes、uniqueDays等）。
2) カテゴリごとのテーブル（昇順）を走査し、条件を満たす未解放レコードを解放。
3) 単発条件（single）や週次（weekly）は Activity または週集計に対し即時計算。
4) 解放イベントをキューイングし、演出（通常→大演出）順でモーダル表示。

## ID設計（例）
- 総合: `sum_0001` 〜 `sum_0040`
- ラン距離: `run_0001` 〜 `run_0040`
- ウォーク距離: `walk_0001` 〜 `walk_0030`
- サイクル距離: `cycle_0001` 〜 `cycle_0030`
- 総時間: `time_0001` 〜 `time_0030`
- 累計日数: `days_0001` 〜 `days_0020`
- 特殊コンボ: `combo_0001` 〜 `combo_0010`

## 画面と体験（v1）
- 入力UI: 種目セレクト、距離、分、日付、メモ。保存後に獲得XP・次レベルまでの残り、近い称号を表示。
- ダッシュボード: 現在Lv/XPバー、今日/今週/累計（距離/分/回）、種目別サマリ、直近の称号。
- 称号一覧: カテゴリタブ、獲得/未獲得切替、検索。装備（ピン留め）はv1.1。
- 演出: 通常レベルアップ=小ポップ＋コンフェッティ。節目/希少称号=大演出（v1.1）。

## 受け入れ基準（抜粋）
- 同距離・同分・同日の入力で、runのXP ≥ walkのXP・cycleのXPの各2倍以上。
- 指定閾値で各カテゴリの称号が重複なく解放される。
- 加重総距離が `2.5/1.25/1.0` の重みに一致。
- 保存→演出までローカルで500ms以内。複数解放はキュー順制御。

---

## 称号テーブル（閾値）

以下は名称と到達条件の一覧です。名称は固有表現で重複なし。実装では上記ID規則でスラグを採番してください。

### 1) 総合（加重総距離）40個
1. 路上の露滴（5km）
2. 薄明トレイル（10km）
3. 石畳セレナーデ（20km）
4. アスファルト小夜曲（30km）
5. フルの呼吸線（42.195km）
6. 黒路のしるし（50km）
7. 遠雷の轍（75km）
8. 境界標拾い（100km）
9. 風紋の越境（150km）
10. 街道の等高線（200km）
11. 路面の織目（250km）
12. 稜線インデックス（300km）
13. 方位磁針の歌（400km）
14. 交差点の記憶（500km）
15. 低空の航跡（650km）
16. 風下の設計図（800km）
17. 里程標蒐集家（1000km）
18. 乾いた地図帳（1250km）
19. 走路の化石（1500km）
20. 地平の綴じ目（2000km）
21. 旋回する里程（2500km）
22. 舗道アーカイブ（3000km）
23. 砂利と恒星（3500km）
24. 車道の余白（4000km）
25. 路傍の金継ぎ（5000km）
26. 風景の背骨（6000km）
27. 雲間のコンパス（7000km）
28. 風切のグラフ（8000km）
29. 夜明けの軌条（9000km）
30. 走路の星図（10000km）
31. 地物語の継承（12000km）
32. 轍の文庫（14000km）
33. 乾坤の歩記（16000km）
34. 道筋の合本（18000km）
35. 距離の錬金（20000km）
36. 地平のしおり（22000km）
37. 里程の譜面（25000km）
38. 風景の長編（30000km）
39. 走路終盤説（40000km）
40. 経路の宙（50000km）

### 2) ランニング距離 40個
1. 踵点火（1km）
2. 呼気二拍子（2km）
3. 皮膚で風（3km）
4. 五千の脚注（5km）
5. 脛骨の合図（7km）
6. 心拍の拍子木（10km）
7. 路面ハイライナー（12km）
8. 腕振り工学（15km）
9. 跳ね返り設計（18km）
10. 中間点の誓い（21.097km）
11. 接地の書式（25km）
12. 脚音スタッカート（30km）
13. 失速抗体（35km）
14. 余裕度ゼロ帯（37km）
15. 壁を撫でる（40km）
16. 完走の版刻（42.195km）
17. 脚の第二言語（50km）
18. 乳酸の和解（60km）
19. 走心の定着（70km）
20. 距離感の反転（80km）
21. ロード耐性核（90km）
22. 百里の署名（100km）
23. ペース微分体（120km）
24. ラップの錬師（140km）
25. 百マイルの証憑（160.934km）
26. 無音の加速域（180km）
27. 脚筋の静脈（200km）
28. 足裏パレット（250km）
29. 風上リズム論（300km）
30. 心肺の工作室（350km）
31. セカンドウィンド標（400km）
32. ピッチの設計図（450km）
33. スプリット管制（500km）
34. 長脚の座右（600km）
35. ペース航海図（700km）
36. 手前重心の国（800km）
37. 余白のダッシュ（900km）
38. 千の足あと（1000km）
39. 走路長編作（1500km）
40. 距離との停戦（2000km）

### 3) ウォーキング距離 30個
1. 靴底の栞（3km）
2. 路地の影絵（5km）
3. 角を曲がる哲学（7km）
4. 逍遥の標本（10km）
5. 石段インベントリ（12km）
6. 表情の収集帳（15km）
7. 路傍メモラブル（20km）
8. 街角キュレーター（25km）
9. 舗道アトリエ（30km）
10. 港町の歩幅（40km）
11. 換気する散策（50km）
12. 静寂インターバル（60km）
13. 里道ノート（75km）
14. 視界の余白術（90km）
15. 千鳥の歩格（100km）
16. 郷愁ルートマップ（125km）
17. 午後の歩学（150km）
18. 夕暮れの地図係（175km）
19. 空と舗道の間（200km）
20. 角砂糖の遠足（225km）
21. 鞄の軽量化（250km）
22. 影と並走（300km）
23. 歩幅の航海（400km）
24. 石畳の百科（500km）
25. 路紋アーカイバー（600km）
26. 黄昏スキャナー（700km）
27. 余白設計主（800km）
28. 夕影プロセッション（900km）
29. 歩記タイポロジー（1000km）
30. 巡歴カルテ（1500km）

### 4) サイクリング距離 30個
1. スポークの初等（10km）
2. 風切りカセット（20km）
3. クランク二回転（30km）
4. 航路ホイール（40km）
5. 路風ギヤ比（50km）
6. チェーンの歌口（75km）
7. センチュリー予報（100km）
8. リム航測（125km）
9. ペダル円弧学（150km）
10. 旋風ドラフティング（200km）
11. 歯車の牧歌（250km）
12. 直線の無口（300km）
13. 追い風編集室（350km）
14. 風上パイロット（400km）
15. カルマン・ホイッスル（500km）
16. 路上ベクトル場（600km）
17. ハブの冠星（700km）
18. シフト連弾（800km）
19. 斜度の対話（900km）
20. 等速の誓文（1000km）
21. ブルベ気流図（1200km）
22. 砂利と胎動（1500km）
23. グランフォンド手稿（2000km）
24. 逆風の礼節（2500km）
25. 乗車角と余白（3000km）
26. 変速機械学（3500km）
27. リムの座右（4000km）
28. 風景等速機（5000km）
29. 空気の航宙（7500km）
30. 走輪年代記（10000km）

### 5) 総時間（分）30個
1. 三十分の居場所（30分）
2. 時の浅瀬（60分）
3. 二時間の静脈（120分）
4. 三時間の梯子（180分）
5. 四時間の座標（240分）
6. 五時間の懐中（300分）
7. 六時間の余白（360分）
8. 七時間の灯（420分）
9. 八時間の背骨（480分）
10. 十時間の窓（600分）
11. 十二時間の磁場（720分）
12. 十五時間の冠（900分）
13. 二十時間の遠心（1200分）
14. 二十五時間の仮説（1500分）
15. 三十時間の定着（1800分）
16. 三十五時間の鈍色（2100分）
17. 四十時間の羅針（2400分）
18. 五十時間の静圧（3000分）
19. 六十時間の深呼（3600分）
20. 七十時間の軸受（4200分）
21. 八十時間の星霜（4800分）
22. 九十時間の余熱（5400分）
23. 百時間の余韻（6000分）
24. 百十六時間の頁（7000分）
25. 百三十三時間の刻（8000分）
26. 百五十時間の環（9000分）
27. 百六十七時間の句（10000分）
28. 二百時間の視差（12000分）
29. 二百五十時間の脈絡（15000分）
30. 三百三十三時間の宙（20000分）

### 6) 累計日数 20個
1. 起点の印（1日）
2. 三日目の旗（3日）
3. 五日の芽生え（5日）
4. 二桁の戸口（10日）
5. 十五日の磁石（15日）
6. 二十日の輪郭（20日）
7. 二十五日の糸口（25日）
8. 三十日の設計図（30日）
9. 四十五日の踊り場（45日）
10. 六十日の文脈（60日）
11. 七十五日の棟木（75日）
12. 九十日の定着（90日）
13. 百二十日の季節帯（120日）
14. 百五十日の梁（150日）
15. 百八十日の等時線（180日）
16. 二百二十日の据え（220日）
17. 二百六十日の構造（260日）
18. 三百日の記憶箱（300日）
19. 三百六十五日の環（365日）
20. 五百日の航跡（500日）

### 7) 特殊コンボ 10個（v1.1）
1. 三相運動の祈り（同一日に3種目すべて記録）code=daily_all_three
2. 夜明六時の盟約（同一日に朝6時まで合計60分以上）code=daily_before6_60min（timeが未入力の場合は対象外）
3. 街を横断する定義（単日合計30km以上）code=daily_30km
4. 斜面と平地の協定（同一週：ラン≥20km＋ウォーク≥20km）code=weekly_run20_walk20（週開始: 月曜）
5. 長日輪舞（単日合計6時間以上）code=daily_6h
6. 二輪一走の交差点（同一日：任意の2種目で各10km以上）code=daily_two_types_10km
7. 静動アンサンブル（同一週：ウォーク≥40km＋ラン≥30km）code=weekly_walk40_run30
8. 三時間の宣言（単日合計180分以上）code=daily_180min
9. 複章コレクター（総合称号10個以上解放）code=sum_titles_10
10. 路譜の統合者（各カテゴリ最上位称号を1つ以上解放）code=top_any_category_completed

---

## 判定フロー（擬似コード）
```
onSave(activity):
  validate(activity)
  persist(activity)
  totals = updateTotalsDiff(activity)

  xp = calcXp(activity)
  profile.totalXp += xp
  while (profile.totalXp >= profile.nextLevelRequiredXp):
    profile.level++
    profile.totalXp -= profile.nextLevelRequiredXp
    profile.nextLevelRequiredXp = req(profile.level)
    enqueueEffect('levelUp', milestone(profile.level))

  newlyUnlocked = []
  for each category in [sum, run, walk, cycle, time, days]:
    newlyUnlocked += unlockIfReached(category, totals, activity)
  newlyUnlocked += evalCombos(activities, totals, unlocked)

  enqueueEffect('achievements', newlyUnlocked)
  playEffectsInOrder()
```

## 今後の拡張
- v1.1: 特殊コンボ、節目大演出、装備バッジ。
- v1.2: 週間目標/ストリーク、SNS共有、推奨称号ガイド。
- v1.3: 簡易バックアップ/リストア、CSVインポート。

以上です。数値（係数・しきい値）は実走テストで後日微調整可能なよう、Profile.settingsで外部化します。
