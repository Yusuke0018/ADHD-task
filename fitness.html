<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>フィットネス記録 | 二十四節気</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1f2937">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles/base.css?v=3">
  <link rel="stylesheet" href="styles/animations.css?v=3">
  <link rel="stylesheet" href="styles/components.css?v=3">
  <link rel="stylesheet" href="styles/fitness.css?v=3">
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-3xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold text-gray-800">フィットネス記録</h1>
      <a href="index.html" class="text-sm text-blue-600 hover:underline">二十四節気へ戻る</a>
    </header>

    <!-- ハイテンション入力（新しいクイック入力UI） -->
    <section class="washi-card p-4 rounded-2xl mb-4" id="fxTurbo">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold text-gray-800">ハイテンション入力</h2>
        <span id="fxTurboMotivation" class="text-xs text-gray-600"></span>
      </div>

      <!-- 種目セレクタ（プルダウン式） -->
      <div class="text-sm font-semibold text-gray-800 mb-1">種目</div>
      <div class="mb-3">
        <button id="txTypePicker" type="button" class="select-chip w-full" aria-haspopup="dialog" aria-expanded="false"><span id="txTypeLabel">ラン</span></button>
      </div>
      <!-- 種目メニュー（オーバーレイ） -->
      <div id="txTypeMenu" class="type-menu hidden" aria-hidden="true">
        <div class="type-menu-backdrop" id="txTypeMenuBackdrop"></div>
        <div class="type-sheet">
          <div class="type-sheet-header">種目を選択</div>
          <div class="type-sheet-content">
            <button id="txTypeRun" class="menu-item" aria-selected="true">ラン</button>
            <button id="txTypeWalk" class="menu-item" aria-selected="false">ウォーク</button>
            <button id="txTypeCycle" class="menu-item" aria-selected="false">サイクル</button>
          </div>
          <button class="menu-close" id="txTypeMenuClose">閉じる</button>
        </div>
      </div>

      <!-- 距離コントロール -->
      <div class="mb-3">
        <div class="flex items-center justify-between mb-1">
          <div class="text-sm font-semibold text-gray-800">距離</div>
          <div class="text-xs text-gray-600">タップで加算</div>
        </div>
        <div class="flex items-center gap-2 mb-2">
          <button class="stepper" id="txDistMinus">−</button>
          <div class="grow text-center">
            <div class="text-2xl font-bold text-gray-900" id="txDistanceView">0.0</div>
            <div class="text-xs text-gray-500">km</div>
          </div>
          <button class="stepper" id="txDistPlus">＋</button>
        </div>
        <div class="grid grid-cols-5 gap-2">
          <button class="chip" data-add-dist="0.5">+0.5</button>
          <button class="chip" data-add-dist="1">+1</button>
          <button class="chip" data-add-dist="2">+2</button>
          <button class="chip" data-add-dist="3">+3</button>
          <button class="chip" data-add-dist="5">+5</button>
        </div>
      </div>

      <!-- 時間コントロール -->
      <div class="mb-3">
        <div class="flex items-center justify-between mb-1">
          <div class="text-sm font-semibold text-gray-800">分</div>
          <div class="text-xs text-gray-600">タップで加算</div>
        </div>
        <div class="flex items-center gap-2 mb-2">
          <button class="stepper" id="txMinMinus">−</button>
          <div class="grow text-center">
            <div class="text-2xl font-bold text-gray-900" id="txMinutesView">0</div>
            <div class="text-xs text-gray-500">min</div>
          </div>
          <button class="stepper" id="txMinPlus">＋</button>
        </div>
        <div class="grid grid-cols-4 gap-2">
          <button class="chip" data-add-min="10">+10</button>
          <button class="chip" data-add-min="20">+20</button>
          <button class="chip" data-add-min="30">+30</button>
          <button class="chip" data-add-min="45">+45</button>
        </div>
      </div>

      <!-- 日付・時間ショートカット -->
      <div class="mb-3">
        <div class="text-sm font-semibold text-gray-800 mb-1">日付と時間</div>
        <div class="grid grid-cols-2 gap-2 mb-2">
          <button class="chip alt w-full" id="txToday">今日</button>
          <button class="chip alt w-full" id="txYesterday">昨日</button>
        </div>
        <div class="grid grid-cols-3 gap-2">
          <button class="chip alt" data-set-time="06:00">🌅 朝(6:00)</button>
          <button class="chip alt" data-set-time="12:00">🌤️ 昼(12:00)</button>
          <button class="chip alt" data-set-time="21:00">🌙 夜(21:00)</button>
        </div>
      </div>

      <!-- ひとこと & XP 事前表示 -->
      <div class="flex items-center justify-between text-sm mb-2">
        <div id="txSummary" class="text-gray-700">今日は — / —</div>
        <div id="txXpPreview" class="text-blue-600 font-semibold">+0 XP</div>
      </div>

      <!-- クイックコンボ -->
      <div class="mb-3">
        <div class="text-sm font-semibold text-gray-800 mb-1">ワンタップ</div>
        <div class="grid grid-cols-3 gap-2">
          <button class="combo" data-combo='{"type":"run","km":3,"min":20,"time":"06:30"}'>朝ラン 3km/20分</button>
          <button class="combo" data-combo='{"type":"walk","km":2,"min":20,"time":"12:15"}'>散歩 2km/20分</button>
          <button class="combo" data-combo='{"type":"cycle","km":5,"min":15,"time":"17:30"}'>サイクル 5km/15分</button>
        </div>
      </div>

      <!-- セーブアクション -->
      <div class="flex items-center gap-2">
        <button id="txRecallLast" class="chip alt">昨日と同じ！</button>
        <button id="txSave" class="save-button flex-1">保存して進化！</button>
      </div>
      <div id="txResult" class="text-xs text-gray-600 mt-2"></div>
    </section>

    <div class="grid md:grid-cols-2 gap-4">
      <!-- 入力カード -->
      <section class="washi-card p-4 rounded-2xl" id="fxAdvanced">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold text-gray-800">詳細入力</h2>
          <button id="fxAdvancedToggle" class="text-sm text-blue-600 hover:underline">隠す</button>
        </div>
        <div class="space-y-3">
          <div>
            <label class="block text-sm text-gray-700 mb-1">種目</label>
            <select id="fxType" class="form-input">
              <option value="run">ランニング</option>
              <option value="walk">ウォーキング</option>
              <option value="cycle">サイクリング</option>
            </select>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="block text-sm text-gray-700 mb-1">距離 (km)</label>
              <input id="fxDistance" type="number" step="0.01" min="0" placeholder="例: 5.0" class="form-input" />
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">分 (min)</label>
              <input id="fxMinutes" type="number" step="1" min="1" placeholder="例: 30" class="form-input" />
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">開始時刻（任意）</label>
              <input id="fxTime" type="time" class="form-input" />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-gray-700 mb-1">日付</label>
              <input id="fxDate" type="date" class="form-input" />
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">メモ（任意）</label>
              <input id="fxNote" type="text" maxlength="100" class="form-input" placeholder="体感や天候など" />
            </div>
          </div>
          <button id="fxSave" class="save-button w-full">保存してXP/称号を更新</button>
          <p class="text-xs text-gray-500">※ 開始時刻は一部のコンボ称号（例: 朝6時までの合計分）判定にのみ使用します。</p>

          <div id="fxResult" class="text-sm text-gray-700"></div>
        </div>
      </section>

      <!-- ダッシュボードカード -->
      <section class="washi-card p-4 rounded-2xl">
        <h2 class="text-lg font-semibold text-gray-800 mb-3">ダッシュボード</h2>
        <div id="fxLevelBox" class="mb-3">
          <div class="flex items-center justify-between mb-1">
            <div class="text-gray-700 text-sm">レベル</div>
            <div id="fxLevel" class="font-semibold">Lv 1</div>
          </div>
          <div class="h-2 bg-gray-200 rounded">
            <div id="fxXpBar" class="h-2 bg-blue-500 rounded" style="width: 0%"></div>
          </div>
          <div id="fxXpText" class="text-right text-xs text-gray-600 mt-1">0 / 150 XP</div>
        </div>

        <div class="grid grid-cols-4 gap-2 text-center mb-3">
          <div class="mini-card">
            <div class="text-xs text-gray-600">加重総距離</div>
            <div id="fxWeighted" class="font-semibold">0.00 km</div>
          </div>
          <div class="mini-card">
            <div class="text-xs text-gray-600">合計分</div>
            <div id="fxTotalMin" class="font-semibold">0 分</div>
          </div>
          <div class="mini-card">
            <div class="text-xs text-gray-600">記録日数</div>
            <div id="fxDays" class="font-semibold">0 日</div>
          </div>
          <div class="mini-card">
            <div class="text-xs text-gray-600">連続日数</div>
            <div id="fxStreak" class="font-semibold">0 日</div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2 text-center">
          <div class="mini-card">
            <div class="text-xs text-gray-600">ラン距離</div>
            <div id="fxRunKm" class="font-semibold">0.00 km</div>
          </div>
          <div class="mini-card">
            <div class="text-xs text-gray-600">ウォーク距離</div>
            <div id="fxWalkKm" class="font-semibold">0.00 km</div>
          </div>
          <div class="mini-card">
            <div class="text-xs text-gray-600">サイクル距離</div>
            <div id="fxCycleKm" class="font-semibold">0.00 km</div>
          </div>
        </div>
      </section>
    </div>

    <!-- 履歴 -->
    <section class="washi-card p-4 rounded-2xl mt-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold text-gray-800">履歴</h2>
        <button id="fxExport" class="text-sm text-blue-600 hover:underline">エクスポート</button>
      </div>
      <div id="fxHistory" class="space-y-2"></div>
    </section>

    <!-- 称号 -->
    <section class="washi-card p-4 rounded-2xl mt-4">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">称号</h2>
      <div id="fxTitlesSummary" class="text-sm text-gray-700 mb-2"></div>
      <div id="fxNextTargets" class="text-sm text-gray-700"></div>
    </section>

    <!-- 装備バッジ -->
    <section class="washi-card p-4 rounded-2xl mt-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold text-gray-800">装備バッジ（最大5つ）</h2>
        <button id="fxToggleEquip" class="text-sm text-blue-600 hover:underline">選択</button>
      </div>
      <div id="fxEquipped" class="flex flex-wrap gap-2 mb-2"></div>
      <div id="fxEquipList" class="hidden max-h-64 overflow-y-auto border rounded-lg p-2 bg-white/60"></div>
    </section>

    <!-- 週間目標 -->
    <section class="washi-card p-4 rounded-2xl mt-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold text-gray-800">週間目標</h2>
        <button id="fxGoalsEdit" class="text-sm text-blue-600 hover:underline">編集</button>
      </div>
      <div id="fxGoalsView" class="space-y-2"></div>
      <div id="fxGoalsEditForm" class="hidden grid grid-cols-3 gap-2 mt-2">
        <div>
          <label class="block text-xs text-gray-600 mb-1">ラン目標(km)</label>
          <input id="fxGoalRun" type="number" step="1" min="0" class="form-input" />
        </div>
        <div>
          <label class="block text-xs text-gray-600 mb-1">ウォーク目標(km)</label>
          <input id="fxGoalWalk" type="number" step="1" min="0" class="form-input" />
        </div>
        <div>
          <label class="block text-xs text-gray-600 mb-1">サイクル目標(km)</label>
          <input id="fxGoalCycle" type="number" step="1" min="0" class="form-input" />
        </div>
        <div class="col-span-3 flex justify-end gap-2">
          <button id="fxGoalsCancel" class="px-3 py-2 rounded-lg bg-gray-200 text-gray-800">キャンセル</button>
          <button id="fxGoalsSave" class="save-button">保存</button>
        </div>
      </div>
    </section>
  </div>

  <!-- レベルアップ演出 -->
  <div id="levelUpOverlay" class="levelup-overlay hidden">
    <div class="levelup-modal">
      <div class="levelup-confetti" aria-hidden="true"></div>
      <div id="levelUpText" class="text-2xl font-bold">Level Up!</div>
    </div>
  </div>

  <div id="levelUpOverlayLarge" class="levelup-overlay hidden">
    <div class="levelup-modal levelup-modal-large">
      <div class="levelup-confetti levelup-confetti-large" aria-hidden="true"></div>
      <div id="levelUpTextLarge" class="text-3xl font-extrabold">Milestone!</div>
      <div class="text-sm text-gray-600 mt-1">節目レベル到達おめでとうございます</div>
    </div>
  </div>

  <script src="js/fitness-data.js?v=1"></script>
  <script type="module" src="js/fitness-app.js?v=1"></script>
  <script>
    // ハイテンション入力の挙動を既存保存ロジックに橋渡し
    document.addEventListener('DOMContentLoaded', () => {
      // 状態
      let txType = 'run';
      let txKm = 0.0;
      let txMin = 0;
      let txDate = (new Date()).toISOString().slice(0,10);
      let txTime = '';

      const messages = [
        'いい波来てます！','今日は伸びる日！','ナイス集中！','軽く一歩！','未来の自分が拍手中！','その一歩が金メダル！'
      ];
      const $ = s=>document.querySelector(s);
      const fmtKm = v => (Math.max(0, Math.min(200, v))).toFixed(1);
      const clampMin = v => Math.max(0, Math.min(600, Math.round(v)));

      function setType(t){
        txType = t;
        const targetId = t === 'run' ? 'txTypeRun' : t === 'walk' ? 'txTypeWalk' : 'txTypeCycle';
        ['txTypeRun','txTypeWalk','txTypeCycle'].forEach(id => {
          const b = document.getElementById(id);
          if(!b) return;
          const on = (id === targetId);
          b.setAttribute('aria-selected', on ? 'true' : 'false');
          b.classList.toggle('active', on);
        });
        const lbl = document.getElementById('txTypeLabel');
        if(lbl) lbl.textContent = t==='run'?'ラン': t==='walk'?'ウォーク':'サイクル';
        updatePreview();
      }

      function openTxMenu(){ const m=document.getElementById('txTypeMenu'); const p=document.getElementById('txTypePicker'); if(m&&p){ m.classList.remove('hidden'); p.setAttribute('aria-expanded','true'); } }
      function closeTxMenu(){ const m=document.getElementById('txTypeMenu'); const p=document.getElementById('txTypePicker'); if(m&&p){ m.classList.add('hidden'); p.setAttribute('aria-expanded','false'); } }
      function setKm(v){ txKm = parseFloat(fmtKm(v)); $('#txDistanceView').textContent = txKm.toFixed(1); updatePreview(); }
      function setMin(v){ txMin = clampMin(v); $('#txMinutesView').textContent = txMin; updatePreview(); }
      function setDateStr(str){ txDate = str; updatePreview(); }
      function setTimeStr(str){ txTime = str || ''; updatePreview(); }
      function todayStr(d = new Date()){ const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate()); return dt.toISOString().slice(0,10); }

      function updatePreview(){
        const typeLabel = txType==='run'?'ラン': txType==='walk'?'ウォーク':'サイクル';
        $('#txSummary').textContent = `${typeLabel} ${txKm.toFixed(1)}km / ${txMin}分 ${txDate}` + (txTime?` ${txTime}`:'');
        // XPプレビュー（既存モジュール内スコープのため概算: ラン×2.4, ウォーク×1.2, サイクル×1.0）
        const base = 12 * Math.pow(txKm, 0.9) + 5 * Math.sqrt(Math.max(0, txMin));
        const k = txType==='run'?2.4: txType==='walk'?1.2:1.0;
        const xp = Math.round(base * k);
        $('#txXpPreview').textContent = `+${isNaN(xp)?0:xp} XP`;
      }

      // 初期表示
      $('#fxTurboMotivation').textContent = messages[Math.floor(Math.random()*messages.length)];
      setType('run'); setKm(0); setMin(0); setDateStr(todayStr());

      // 種目メニュー
      $('#txTypePicker')?.addEventListener('click', ()=> openTxMenu());
      $('#txTypeMenuBackdrop')?.addEventListener('click', ()=> closeTxMenu());
      $('#txTypeMenuClose')?.addEventListener('click', ()=> closeTxMenu());
      $('#txTypeRun')?.addEventListener('click', ()=> { setType('run'); closeTxMenu(); });
      $('#txTypeWalk')?.addEventListener('click', ()=> { setType('walk'); closeTxMenu(); });
      $('#txTypeCycle')?.addEventListener('click', ()=> { setType('cycle'); closeTxMenu(); });

      // 距離
      $('#txDistMinus')?.addEventListener('click', ()=> setKm(txKm - 0.5));
      $('#txDistPlus')?.addEventListener('click', ()=> setKm(txKm + 0.5));
      document.querySelectorAll('#fxTurbo .chip[data-add-dist]')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{ const add = parseFloat(btn.getAttribute('data-add-dist')||'0'); setKm(txKm + add); });
      });
      // 時間
      $('#txMinMinus')?.addEventListener('click', ()=> setMin(txMin - 5));
      $('#txMinPlus')?.addEventListener('click', ()=> setMin(txMin + 5));
      document.querySelectorAll('#fxTurbo .chip[data-add-min]')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{ const add = parseInt(btn.getAttribute('data-add-min')||'0',10); setMin(txMin + add); });
      });

      // 日付/時間
      $('#txToday')?.addEventListener('click', ()=> setDateStr(todayStr()));
      $('#txYesterday')?.addEventListener('click', ()=>{ const d=new Date(); d.setDate(d.getDate()-1); setDateStr(todayStr(d)); });
      document.querySelectorAll('#fxTurbo .chip[data-set-time]')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{ setTimeStr(btn.getAttribute('data-set-time')||''); });
      });

      // コンボ
      document.querySelectorAll('#fxTurbo .combo')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          try{
            const c = JSON.parse(btn.getAttribute('data-combo')||'{}');
            if(c.type) setType(c.type);
            if(c.km!=null) setKm(c.km);
            if(c.min!=null) setMin(c.min);
            if(c.time) setTimeStr(c.time);
            setDateStr(todayStr());
          }catch{}
        });
      });

      // 昨日と同じ（直近再現して日付を今日に）
      $('#txRecallLast')?.addEventListener('click', ()=>{
        try{
          const acts = JSON.parse(localStorage.getItem('fitness_activities')||'[]');
          if(!acts.length){ $('#txResult').textContent='直近の記録がありません'; return; }
          const last = acts.sort((a,b)=> b.addedAt.localeCompare(a.addedAt))[0];
          setType(last.type||'run'); setKm(last.distanceKm||0); setMin(last.minutes||0);
          setDateStr(todayStr()); setTimeStr(last.time||'');
          $('#txResult').textContent = '直近を今日分としてセットしました';
        }catch{ $('#txResult').textContent='直近の取得に失敗しました'; }
      });

      // 保存：既存の詳細入力欄に値を入れて fxSave をクリック
      $('#txSave')?.addEventListener('click', ()=>{
        // 詳細欄が隠れていても値はセットできる
        const typeEl = document.getElementById('fxType');
        const distEl = document.getElementById('fxDistance');
        const minEl = document.getElementById('fxMinutes');
        const dateEl = document.getElementById('fxDate');
        const timeEl = document.getElementById('fxTime');

        if(typeEl) typeEl.value = txType;
        if(distEl) distEl.value = txKm.toFixed(2);
        if(minEl) minEl.value = String(txMin);
        if(dateEl) dateEl.value = txDate;
        if(timeEl) timeEl.value = txTime;

        const btn = document.getElementById('fxSave');
        if(btn){ btn.click(); $('#txResult').textContent = '保存しました！'; }
      });

      // 詳細入力の折りたたみ
      const adv = document.getElementById('fxAdvanced');
      const advBtn = document.getElementById('fxAdvancedToggle');
      advBtn?.addEventListener('click', ()=>{
        const body = adv?.querySelector('.space-y-3');
        if(!body) return;
        const hidden = body.classList.toggle('hidden');
        advBtn.textContent = hidden? '表示' : '隠す';
      });

    });
  </script>
  <script>
    // SW登録（既存と同一のSWを利用）
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }
  </script>
</body>
</html>
